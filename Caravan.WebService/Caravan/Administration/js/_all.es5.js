/*global angular */

/**
 * The main TodoMVC app module
 *
 * @type {angular.Module}
 */
'use strict';

angular.module('todomvc', ['ngRoute']).config(function ($routeProvider) {
	'use strict';

	var routeConfig = {
		controller: 'TodoCtrl',
		templateUrl: 'todomvc-index.html',
		resolve: {
			store: function store(todoStorage) {
				// Get the correct module (API or localStorage).
				return todoStorage.then(function (module) {
					module.get(); // Fetch the todo records in the background.
					return module;
				});
			}
		}
	};

	$routeProvider.when('/', routeConfig).when('/:status', routeConfig).otherwise({
		redirectTo: '/'
	});
});

/*global angular */

/**
 * The main controller for the app. The controller:
 * - retrieves and persists the model via the todoStorage service
 * - exposes the model to the template and provides event handlers
 */
angular.module('todomvc').controller('TodoCtrl', function TodoCtrl($scope, $routeParams, $filter, store) {
	'use strict';

	var todos = $scope.todos = store.todos;

	$scope.newTodo = '';
	$scope.editedTodo = null;

	$scope.$watch('todos', function () {
		$scope.remainingCount = $filter('filter')(todos, { completed: false }).length;
		$scope.completedCount = todos.length - $scope.remainingCount;
		$scope.allChecked = !$scope.remainingCount;
	}, true);

	// Monitor the current route for changes and adjust the filter accordingly.
	$scope.$on('$routeChangeSuccess', function () {
		var status = $scope.status = $routeParams.status || '';
		$scope.statusFilter = status === 'active' ? { completed: false } : status === 'completed' ? { completed: true } : {};
	});

	$scope.addTodo = function () {
		var newTodo = {
			title: $scope.newTodo.trim(),
			completed: false
		};

		if (!newTodo.title) {
			return;
		}

		$scope.saving = true;
		store.insert(newTodo).then(function success() {
			$scope.newTodo = '';
		})['finally'](function () {
			$scope.saving = false;
		});
	};

	$scope.editTodo = function (todo) {
		$scope.editedTodo = todo;
		// Clone the original todo to restore it on demand.
		$scope.originalTodo = angular.extend({}, todo);
	};

	$scope.saveEdits = function (todo, event) {
		// Blur events are automatically triggered after the form submit event.
		// This does some unfortunate logic handling to prevent saving twice.
		if (event === 'blur' && $scope.saveEvent === 'submit') {
			$scope.saveEvent = null;
			return;
		}

		$scope.saveEvent = event;

		if ($scope.reverted) {
			// Todo edits were reverted-- don't save.
			$scope.reverted = null;
			return;
		}

		todo.title = todo.title.trim();

		if (todo.title === $scope.originalTodo.title) {
			$scope.editedTodo = null;
			return;
		}

		store[todo.title ? 'put' : 'delete'](todo).then(function success() {}, function error() {
			todo.title = $scope.originalTodo.title;
		})['finally'](function () {
			$scope.editedTodo = null;
		});
	};

	$scope.revertEdits = function (todo) {
		todos[todos.indexOf(todo)] = $scope.originalTodo;
		$scope.editedTodo = null;
		$scope.originalTodo = null;
		$scope.reverted = true;
	};

	$scope.removeTodo = function (todo) {
		store['delete'](todo);
	};

	$scope.saveTodo = function (todo) {
		store.put(todo);
	};

	$scope.toggleCompleted = function (todo, completed) {
		if (angular.isDefined(completed)) {
			todo.completed = completed;
		}
		store.put(todo, todos.indexOf(todo)).then(function success() {}, function error() {
			todo.completed = !todo.completed;
		});
	};

	$scope.clearCompletedTodos = function () {
		store.clearCompleted();
	};

	$scope.markAll = function (completed) {
		todos.forEach(function (todo) {
			if (todo.completed !== completed) {
				$scope.toggleCompleted(todo, completed);
			}
		});
	};
});

/*global angular */

/**
 * Services that persists and retrieves todos from localStorage or a backend API
 * if available.
 *
 * They both follow the same API, returning promises for all changes to the
 * model.
 */
angular.module('todomvc').factory('todoStorage', function ($http, $injector) {
	'use strict';

	// Detect if an API backend is present. If so, return the API module, else
	// hand off the localStorage adapter
	return $http.get('/api').then(function () {
		return $injector.get('api');
	}, function () {
		return $injector.get('localStorage');
	});
}).factory('api', function ($http) {
	'use strict';

	var store = {
		todos: [],

		clearCompleted: function clearCompleted() {
			var originalTodos = store.todos.slice(0);

			var completeTodos = [];
			var incompleteTodos = [];
			store.todos.forEach(function (todo) {
				if (todo.completed) {
					completeTodos.push(todo);
				} else {
					incompleteTodos.push(todo);
				}
			});

			angular.copy(incompleteTodos, store.todos);

			return $http['delete']('/api/todos').then(function success() {
				return store.todos;
			}, function error() {
				angular.copy(originalTodos, store.todos);
				return originalTodos;
			});
		},

		'delete': function _delete(todo) {
			var originalTodos = store.todos.slice(0);

			store.todos.splice(store.todos.indexOf(todo), 1);

			return $http['delete']('/api/todos/' + todo.id).then(function success() {
				return store.todos;
			}, function error() {
				angular.copy(originalTodos, store.todos);
				return originalTodos;
			});
		},

		get: function get() {
			return $http.get('/api/todos').then(function (resp) {
				angular.copy(resp.data, store.todos);
				return store.todos;
			});
		},

		insert: function insert(todo) {
			var originalTodos = store.todos.slice(0);

			return $http.post('/api/todos', todo).then(function success(resp) {
				todo.id = resp.data.id;
				store.todos.push(todo);
				return store.todos;
			}, function error() {
				angular.copy(originalTodos, store.todos);
				return store.todos;
			});
		},

		put: function put(todo) {
			var originalTodos = store.todos.slice(0);

			return $http.put('/api/todos/' + todo.id, todo).then(function success() {
				return store.todos;
			}, function error() {
				angular.copy(originalTodos, store.todos);
				return originalTodos;
			});
		}
	};

	return store;
}).factory('localStorage', function ($q) {
	'use strict';

	var STORAGE_ID = 'todos-angularjs';

	var store = {
		todos: [],

		_getFromLocalStorage: function _getFromLocalStorage() {
			return JSON.parse(localStorage.getItem(STORAGE_ID) || '[]');
		},

		_saveToLocalStorage: function _saveToLocalStorage(todos) {
			localStorage.setItem(STORAGE_ID, JSON.stringify(todos));
		},

		clearCompleted: function clearCompleted() {
			var deferred = $q.defer();

			var completeTodos = [];
			var incompleteTodos = [];
			store.todos.forEach(function (todo) {
				if (todo.completed) {
					completeTodos.push(todo);
				} else {
					incompleteTodos.push(todo);
				}
			});

			angular.copy(incompleteTodos, store.todos);

			store._saveToLocalStorage(store.todos);
			deferred.resolve(store.todos);

			return deferred.promise;
		},

		'delete': function _delete(todo) {
			var deferred = $q.defer();

			store.todos.splice(store.todos.indexOf(todo), 1);

			store._saveToLocalStorage(store.todos);
			deferred.resolve(store.todos);

			return deferred.promise;
		},

		get: function get() {
			var deferred = $q.defer();

			angular.copy(store._getFromLocalStorage(), store.todos);
			deferred.resolve(store.todos);

			return deferred.promise;
		},

		insert: function insert(todo) {
			var deferred = $q.defer();

			store.todos.push(todo);

			store._saveToLocalStorage(store.todos);
			deferred.resolve(store.todos);

			return deferred.promise;
		},

		put: function put(todo, index) {
			var deferred = $q.defer();

			store.todos[index] = todo;

			store._saveToLocalStorage(store.todos);
			deferred.resolve(store.todos);

			return deferred.promise;
		}
	};

	return store;
});

/*global angular */

/**
 * Directive that executes an expression when the element it is applied to gets
 * an `escape` keydown event.
 */
angular.module('todomvc').directive('todoEscape', function () {
	'use strict';

	var ESCAPE_KEY = 27;

	return function (scope, elem, attrs) {
		elem.bind('keydown', function (event) {
			if (event.keyCode === ESCAPE_KEY) {
				scope.$apply(attrs.todoEscape);
			}
		});

		scope.$on('$destroy', function () {
			elem.unbind('keydown');
		});
	};
});

/*global angular */

/**
 * Directive that places focus on the element it is applied to when the
 * expression it binds to evaluates to true
 */
angular.module('todomvc').directive('todoFocus', function todoFocus($timeout) {
	'use strict';

	return function (scope, elem, attrs) {
		scope.$watch(attrs.todoFocus, function (newVal) {
			if (newVal) {
				$timeout(function () {
					elem[0].focus();
				}, 0, false);
			}
		});
	};
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkQ6L1Byb2dldHRpL0ZJTlNBL0NhcmF2YW4vQ2FyYXZhbi5XZWJTZXJ2aWNlL0NhcmF2YW4vQWRtaW5pc3RyYXRpb24vanMvX2FsbC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFPQSxPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQ3BDLE1BQU0sQ0FBQyxVQUFVLGNBQWMsRUFBRTtBQUNqQyxhQUFZLENBQUM7O0FBRWIsS0FBSSxXQUFXLEdBQUc7QUFDakIsWUFBVSxFQUFFLFVBQVU7QUFDdEIsYUFBVyxFQUFFLG9CQUFvQjtBQUNqQyxTQUFPLEVBQUU7QUFDUixRQUFLLEVBQUUsZUFBVSxXQUFXLEVBQUU7O0FBRTdCLFdBQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLE1BQU0sRUFBRTtBQUN6QyxXQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDYixZQUFPLE1BQU0sQ0FBQztLQUNkLENBQUMsQ0FBQztJQUNIO0dBQ0Q7RUFDRCxDQUFDOztBQUVGLGVBQWMsQ0FDWixJQUFJLENBQUMsR0FBRyxFQUFFLFdBQVcsQ0FBQyxDQUN0QixJQUFJLENBQUMsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUM3QixTQUFTLENBQUM7QUFDVixZQUFVLEVBQUUsR0FBRztFQUNmLENBQUMsQ0FBQztDQUNKLENBQUMsQ0FBQzs7Ozs7Ozs7O0FBU0osT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FDdkIsVUFBVSxDQUFDLFVBQVUsRUFBRSxTQUFTLFFBQVEsQ0FBQyxNQUFNLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUU7QUFDL0UsYUFBWSxDQUFDOztBQUViLEtBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQzs7QUFFdkMsT0FBTSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDcEIsT0FBTSxDQUFDLFVBQVUsR0FBRyxJQUFJ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OztBQUViLFFBQU8sVUFBVSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRTtBQUNwQyxPQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsVUFBVSxNQUFNLEVBQUU7QUFDL0MsT0FBSSxNQUFNLEVBQUU7QUFDWCxZQUFRLENBQUMsWUFBWTtBQUNwQixTQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7S0FDaEIsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDYjtHQUNELENBQUMsQ0FBQztFQUNILENBQUM7Q0FDRixDQUFDLENBQUMiLCJmaWxlIjoidW5kZWZpbmVkIiwic291cmNlc0NvbnRlbnQiOlsiLypnbG9iYWwgYW5ndWxhciAqL1xuXG4vKipcbiAqIFRoZSBtYWluIFRvZG9NVkMgYXBwIG1vZHVsZVxuICpcbiAqIEB0eXBlIHthbmd1bGFyLk1vZHVsZX1cbiAqL1xuYW5ndWxhci5tb2R1bGUoJ3RvZG9tdmMnLCBbJ25nUm91dGUnXSlcblx0LmNvbmZpZyhmdW5jdGlvbiAoJHJvdXRlUHJvdmlkZXIpIHtcblx0XHQndXNlIHN0cmljdCc7XG5cblx0XHR2YXIgcm91dGVDb25maWcgPSB7XG5cdFx0XHRjb250cm9sbGVyOiAnVG9kb0N0cmwnLFxuXHRcdFx0dGVtcGxhdGVVcmw6ICd0b2RvbXZjLWluZGV4Lmh0bWwnLFxuXHRcdFx0cmVzb2x2ZToge1xuXHRcdFx0XHRzdG9yZTogZnVuY3Rpb24gKHRvZG9TdG9yYWdlKSB7XG5cdFx0XHRcdFx0Ly8gR2V0IHRoZSBjb3JyZWN0IG1vZHVsZSAoQVBJIG9yIGxvY2FsU3RvcmFnZSkuXG5cdFx0XHRcdFx0cmV0dXJuIHRvZG9TdG9yYWdlLnRoZW4oZnVuY3Rpb24gKG1vZHVsZSkge1xuXHRcdFx0XHRcdFx0bW9kdWxlLmdldCgpOyAvLyBGZXRjaCB0aGUgdG9kbyByZWNvcmRzIGluIHRoZSBiYWNrZ3JvdW5kLlxuXHRcdFx0XHRcdFx0cmV0dXJuIG1vZHVsZTtcblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH07XG5cblx0XHQkcm91dGVQcm92aWRlclxuXHRcdFx0LndoZW4oJy8nLCByb3V0ZUNvbmZpZylcblx0XHRcdC53aGVuKCcvOnN0YXR1cycsIHJvdXRlQ29uZmlnKVxuXHRcdFx0Lm90aGVyd2lzZSh7XG5cdFx0XHRcdHJlZGlyZWN0VG86ICcvJ1xuXHRcdFx0fSk7XG5cdH0pO1xuXHJcbi8qZ2xvYmFsIGFuZ3VsYXIgKi9cblxuLyoqXG4gKiBUaGUgbWFpbiBjb250cm9sbGVyIGZvciB0aGUgYXBwLiBUaGUgY29udHJvbGxlcjpcbiAqIC0gcmV0cmlldmVzIGFuZCBwZXJzaXN0cyB0aGUgbW9kZWwgdmlhIHRoZSB0b2RvU3RvcmFnZSBzZXJ2aWNlXG4gKiAtIGV4cG9zZXMgdGhlIG1vZGVsIHRvIHRoZSB0ZW1wbGF0ZSBhbmQgcHJvdmlkZXMgZXZlbnQgaGFuZGxlcnNcbiAqL1xuYW5ndWxhci5tb2R1bGUoJ3RvZG9tdmMnKVxuXHQuY29udHJvbGxlcignVG9kb0N0cmwnLCBmdW5jdGlvbiBUb2RvQ3RybCgkc2NvcGUsICRyb3V0ZVBhcmFtcywgJGZpbHRlciwgc3RvcmUpIHtcblx0XHQndXNlIHN0cmljdCc7XG5cblx0XHR2YXIgdG9kb3MgPSAkc2NvcGUudG9kb3MgPSBzdG9yZS50b2RvcztcblxuXHRcdCRzY29wZS5uZXdUb2RvID0gJyc7XG5cdFx0JHNjb3BlLmVkaXRlZFRvZG8gPSBudWxsO1xuXG5cdFx0JHNjb3BlLiR3YXRjaCgndG9kb3MnLCBmdW5jdGlvbiAoKSB7XG5cdFx0XHQkc2NvcGUucmVtYWluaW5nQ291bnQgPSAkZmlsdGVyKCdmaWx0ZXInKSh0b2RvcywgeyBjb21wbGV0ZWQ6IGZhbHNlIH0pLmxlbmd0aDtcblx0XHRcdCRzY29wZS5jb21wbGV0ZWRDb3VudCA9IHRvZG9zLmxlbmd0aCAtICRzY29wZS5yZW1haW5pbmdDb3VudDtcblx0XHRcdCRzY29wZS5hbGxDaGVja2VkID0gISRzY29wZS5yZW1haW5pbmdDb3VudDtcblx0XHR9LCB0cnVlKTtcblxuXHRcdC8vIE1vbml0b3IgdGhlIGN1cnJlbnQgcm91dGUgZm9yIGNoYW5nZXMgYW5kIGFkanVzdCB0aGUgZmlsdGVyIGFjY29yZGluZ2x5LlxuXHRcdCRzY29wZS4kb24oJyRyb3V0ZUNoYW5nZVN1Y2Nlc3MnLCBmdW5jdGlvbiAoKSB7XG5cdFx0XHR2YXIgc3RhdHVzID0gJHNjb3BlLnN0YXR1cyA9ICRyb3V0ZVBhcmFtcy5zdGF0dXMgfHwgJyc7XG5cdFx0XHQkc2NvcGUuc3RhdHVzRmlsdGVyID0gKHN0YXR1cyA9PT0gJ2FjdGl2ZScpID9cblx0XHRcdFx0eyBjb21wbGV0ZWQ6IGZhbHNlIH0gOiAoc3RhdHVzID09PSAnY29tcGxldGVkJykgP1xuXHRcdFx0XHR7IGNvbXBsZXRlZDogdHJ1ZSB9IDoge307XG5cdFx0fSk7XG5cblx0XHQkc2NvcGUuYWRkVG9kbyA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdHZhciBuZXdUb2RvID0ge1xuXHRcdFx0XHR0aXRsZTogJHNjb3BlLm5ld1RvZG8udHJpbSgpLFxuXHRcdFx0XHRjb21wbGV0ZWQ6IGZhbHNlXG5cdFx0XHR9O1xuXG5cdFx0XHRpZiAoIW5ld1RvZG8udGl0bGUpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHQkc2NvcGUuc2F2aW5nID0gdHJ1ZTtcblx0XHRcdHN0b3JlLmluc2VydChuZXdUb2RvKVxuXHRcdFx0XHQudGhlbihmdW5jdGlvbiBzdWNjZXNzKCkge1xuXHRcdFx0XHRcdCRzY29wZS5uZXdUb2RvID0gJyc7XG5cdFx0XHRcdH0pXG5cdFx0XHRcdC5maW5hbGx5KGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHQkc2NvcGUuc2F2aW5nID0gZmFsc2U7XG5cdFx0XHRcdH0pO1xuXHRcdH07XG5cblx0XHQkc2NvcGUuZWRpdFRvZG8gPSBmdW5jdGlvbiAodG9kbykge1xuXHRcdFx0JHNjb3BlLmVkaXRlZFRvZG8gPSB0b2RvO1xuXHRcdFx0Ly8gQ2xvbmUgdGhlIG9yaWdpbmFsIHRvZG8gdG8gcmVzdG9yZSBpdCBvbiBkZW1hbmQuXG5cdFx0XHQkc2NvcGUub3JpZ2luYWxUb2RvID0gYW5ndWxhci5leHRlbmQoe30sIHRvZG8pO1xuXHRcdH07XG5cblx0XHQkc2NvcGUuc2F2ZUVkaXRzID0gZnVuY3Rpb24gKHRvZG8sIGV2ZW50KSB7XG5cdFx0XHQvLyBCbHVyIGV2ZW50cyBhcmUgYXV0b21hdGljYWxseSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGZvcm0gc3VibWl0IGV2ZW50LlxuXHRcdFx0Ly8gVGhpcyBkb2VzIHNvbWUgdW5mb3J0dW5hdGUgbG9naWMgaGFuZGxpbmcgdG8gcHJldmVudCBzYXZpbmcgdHdpY2UuXG5cdFx0XHRpZiAoZXZlbnQgPT09ICdibHVyJyAmJiAkc2NvcGUuc2F2ZUV2ZW50ID09PSAnc3VibWl0Jykge1xuXHRcdFx0XHQkc2NvcGUuc2F2ZUV2ZW50ID0gbnVsbDtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHQkc2NvcGUuc2F2ZUV2ZW50ID0gZXZlbnQ7XG5cblx0XHRcdGlmICgkc2NvcGUucmV2ZXJ0ZWQpIHtcblx0XHRcdFx0Ly8gVG9kbyBlZGl0cyB3ZXJlIHJldmVydGVkLS0gZG9uJ3Qgc2F2ZS5cblx0XHRcdFx0JHNjb3BlLnJldmVydGVkID0gbnVsbDtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHR0b2RvLnRpdGxlID0gdG9kby50aXRsZS50cmltKCk7XG5cblx0XHRcdGlmICh0b2RvLnRpdGxlID09PSAkc2NvcGUub3JpZ2luYWxUb2RvLnRpdGxlKSB7XG5cdFx0XHRcdCRzY29wZS5lZGl0ZWRUb2RvID0gbnVsbDtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRzdG9yZVt0b2RvLnRpdGxlID8gJ3B1dCcgOiAnZGVsZXRlJ10odG9kbylcblx0XHRcdFx0LnRoZW4oZnVuY3Rpb24gc3VjY2VzcygpIHt9LCBmdW5jdGlvbiBlcnJvcigpIHtcblx0XHRcdFx0XHR0b2RvLnRpdGxlID0gJHNjb3BlLm9yaWdpbmFsVG9kby50aXRsZTtcblx0XHRcdFx0fSlcblx0XHRcdFx0LmZpbmFsbHkoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdCRzY29wZS5lZGl0ZWRUb2RvID0gbnVsbDtcblx0XHRcdFx0fSk7XG5cdFx0fTtcblxuXHRcdCRzY29wZS5yZXZlcnRFZGl0cyA9IGZ1bmN0aW9uICh0b2RvKSB7XG5cdFx0XHR0b2Rvc1t0b2Rvcy5pbmRleE9mKHRvZG8pXSA9ICRzY29wZS5vcmlnaW5hbFRvZG87XG5cdFx0XHQkc2NvcGUuZWRpdGVkVG9kbyA9IG51bGw7XG5cdFx0XHQkc2NvcGUub3JpZ2luYWxUb2RvID0gbnVsbDtcblx0XHRcdCRzY29wZS5yZXZlcnRlZCA9IHRydWU7XG5cdFx0fTtcblxuXHRcdCRzY29wZS5yZW1vdmVUb2RvID0gZnVuY3Rpb24gKHRvZG8pIHtcblx0XHRcdHN0b3JlLmRlbGV0ZSh0b2RvKTtcblx0XHR9O1xuXG5cdFx0JHNjb3BlLnNhdmVUb2RvID0gZnVuY3Rpb24gKHRvZG8pIHtcblx0XHRcdHN0b3JlLnB1dCh0b2RvKTtcblx0XHR9O1xuXG5cdFx0JHNjb3BlLnRvZ2dsZUNvbXBsZXRlZCA9IGZ1bmN0aW9uICh0b2RvLCBjb21wbGV0ZWQpIHtcblx0XHRcdGlmIChhbmd1bGFyLmlzRGVmaW5lZChjb21wbGV0ZWQpKSB7XG5cdFx0XHRcdHRvZG8uY29tcGxldGVkID0gY29tcGxldGVkO1xuXHRcdFx0fVxuXHRcdFx0c3RvcmUucHV0KHRvZG8sIHRvZG9zLmluZGV4T2YodG9kbykpXG5cdFx0XHRcdC50aGVuKGZ1bmN0aW9uIHN1Y2Nlc3MoKSB7fSwgZnVuY3Rpb24gZXJyb3IoKSB7XG5cdFx0XHRcdFx0dG9kby5jb21wbGV0ZWQgPSAhdG9kby5jb21wbGV0ZWQ7XG5cdFx0XHRcdH0pO1xuXHRcdH07XG5cblx0XHQkc2NvcGUuY2xlYXJDb21wbGV0ZWRUb2RvcyA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdHN0b3JlLmNsZWFyQ29tcGxldGVkKCk7XG5cdFx0fTtcblxuXHRcdCRzY29wZS5tYXJrQWxsID0gZnVuY3Rpb24gKGNvbXBsZXRlZCkge1xuXHRcdFx0dG9kb3MuZm9yRWFjaChmdW5jdGlvbiAodG9kbykge1xuXHRcdFx0XHRpZiAodG9kby5jb21wbGV0ZWQgIT09IGNvbXBsZXRlZCkge1xuXHRcdFx0XHRcdCRzY29wZS50b2dnbGVDb21wbGV0ZWQodG9kbywgY29tcGxldGVkKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fTtcblx0fSk7XG5cclxuLypnbG9iYWwgYW5ndWxhciAqL1xuXG4vKipcbiAqIFNlcnZpY2VzIHRoYXQgcGVyc2lzdHMgYW5kIHJldHJpZXZlcyB0b2RvcyBmcm9tIGxvY2FsU3RvcmFnZSBvciBhIGJhY2tlbmQgQVBJXG4gKiBpZiBhdmFpbGFibGUuXG4gKlxuICogVGhleSBib3RoIGZvbGxvdyB0aGUgc2FtZSBBUEksIHJldHVybmluZyBwcm9taXNlcyBmb3IgYWxsIGNoYW5nZXMgdG8gdGhlXG4gKiBtb2RlbC5cbiAqL1xuYW5ndWxhci5tb2R1bGUoJ3RvZG9tdmMnKVxuXHQuZmFjdG9yeSgndG9kb1N0b3JhZ2UnLCBmdW5jdGlvbiAoJGh0dHAsICRpbmplY3Rvcikge1xuXHRcdCd1c2Ugc3RyaWN0JztcblxuXHRcdC8vIERldGVjdCBpZiBhbiBBUEkgYmFja2VuZCBpcyBwcmVzZW50LiBJZiBzbywgcmV0dXJuIHRoZSBBUEkgbW9kdWxlLCBlbHNlXG5cdFx0Ly8gaGFuZCBvZmYgdGhlIGxvY2FsU3RvcmFnZSBhZGFwdGVyXG5cdFx0cmV0dXJuICRodHRwLmdldCgnL2FwaScpXG5cdFx0XHQudGhlbihmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHJldHVybiAkaW5qZWN0b3IuZ2V0KCdhcGknKTtcblx0XHRcdH0sIGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0cmV0dXJuICRpbmplY3Rvci5nZXQoJ2xvY2FsU3RvcmFnZScpO1xuXHRcdFx0fSk7XG5cdH0pXG5cblx0LmZhY3RvcnkoJ2FwaScsIGZ1bmN0aW9uICgkaHR0cCkge1xuXHRcdCd1c2Ugc3RyaWN0JztcblxuXHRcdHZhciBzdG9yZSA9IHtcblx0XHRcdHRvZG9zOiBbXSxcblxuXHRcdFx0Y2xlYXJDb21wbGV0ZWQ6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0dmFyIG9yaWdpbmFsVG9kb3MgPSBzdG9yZS50b2Rvcy5zbGljZSgwKTtcblxuXHRcdFx0XHR2YXIgY29tcGxldGVUb2RvcyA9IFtdO1xuXHRcdFx0XHR2YXIgaW5jb21wbGV0ZVRvZG9zID0gW107XG5cdFx0XHRcdHN0b3JlLnRvZG9zLmZvckVhY2goZnVuY3Rpb24gKHRvZG8pIHtcblx0XHRcdFx0XHRpZiAodG9kby5jb21wbGV0ZWQpIHtcblx0XHRcdFx0XHRcdGNvbXBsZXRlVG9kb3MucHVzaCh0b2RvKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0aW5jb21wbGV0ZVRvZG9zLnB1c2godG9kbyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRhbmd1bGFyLmNvcHkoaW5jb21wbGV0ZVRvZG9zLCBzdG9yZS50b2Rvcyk7XG5cblx0XHRcdFx0cmV0dXJuICRodHRwLmRlbGV0ZSgnL2FwaS90b2RvcycpXG5cdFx0XHRcdFx0LnRoZW4oZnVuY3Rpb24gc3VjY2VzcygpIHtcblx0XHRcdFx0XHRcdHJldHVybiBzdG9yZS50b2Rvcztcblx0XHRcdFx0XHR9LCBmdW5jdGlvbiBlcnJvcigpIHtcblx0XHRcdFx0XHRcdGFuZ3VsYXIuY29weShvcmlnaW5hbFRvZG9zLCBzdG9yZS50b2Rvcyk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gb3JpZ2luYWxUb2Rvcztcblx0XHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cblx0XHRcdGRlbGV0ZTogZnVuY3Rpb24gKHRvZG8pIHtcblx0XHRcdFx0dmFyIG9yaWdpbmFsVG9kb3MgPSBzdG9yZS50b2Rvcy5zbGljZSgwKTtcblxuXHRcdFx0XHRzdG9yZS50b2Rvcy5zcGxpY2Uoc3RvcmUudG9kb3MuaW5kZXhPZih0b2RvKSwgMSk7XG5cblx0XHRcdFx0cmV0dXJuICRodHRwLmRlbGV0ZSgnL2FwaS90b2Rvcy8nICsgdG9kby5pZClcblx0XHRcdFx0XHQudGhlbihmdW5jdGlvbiBzdWNjZXNzKCkge1xuXHRcdFx0XHRcdFx0cmV0dXJuIHN0b3JlLnRvZG9zO1xuXHRcdFx0XHRcdH0sIGZ1bmN0aW9uIGVycm9yKCkge1xuXHRcdFx0XHRcdFx0YW5ndWxhci5jb3B5KG9yaWdpbmFsVG9kb3MsIHN0b3JlLnRvZG9zKTtcblx0XHRcdFx0XHRcdHJldHVybiBvcmlnaW5hbFRvZG9zO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0fSxcblxuXHRcdFx0Z2V0OiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHJldHVybiAkaHR0cC5nZXQoJy9hcGkvdG9kb3MnKVxuXHRcdFx0XHRcdC50aGVuKGZ1bmN0aW9uIChyZXNwKSB7XG5cdFx0XHRcdFx0XHRhbmd1bGFyLmNvcHkocmVzcC5kYXRhLCBzdG9yZS50b2Rvcyk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gc3RvcmUudG9kb3M7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHR9LFxuXG5cdFx0XHRpbnNlcnQ6IGZ1bmN0aW9uICh0b2RvKSB7XG5cdFx0XHRcdHZhciBvcmlnaW5hbFRvZG9zID0gc3RvcmUudG9kb3Muc2xpY2UoMCk7XG5cblx0XHRcdFx0cmV0dXJuICRodHRwLnBvc3QoJy9hcGkvdG9kb3MnLCB0b2RvKVxuXHRcdFx0XHRcdC50aGVuKGZ1bmN0aW9uIHN1Y2Nlc3MocmVzcCkge1xuXHRcdFx0XHRcdFx0dG9kby5pZCA9IHJlc3AuZGF0YS5pZDtcblx0XHRcdFx0XHRcdHN0b3JlLnRvZG9zLnB1c2godG9kbyk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gc3RvcmUudG9kb3M7XG5cdFx0XHRcdFx0fSwgZnVuY3Rpb24gZXJyb3IoKSB7XG5cdFx0XHRcdFx0XHRhbmd1bGFyLmNvcHkob3JpZ2luYWxUb2Rvcywgc3RvcmUudG9kb3MpO1xuXHRcdFx0XHRcdFx0cmV0dXJuIHN0b3JlLnRvZG9zO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0fSxcblxuXHRcdFx0cHV0OiBmdW5jdGlvbiAodG9kbykge1xuXHRcdFx0XHR2YXIgb3JpZ2luYWxUb2RvcyA9IHN0b3JlLnRvZG9zLnNsaWNlKDApO1xuXG5cdFx0XHRcdHJldHVybiAkaHR0cC5wdXQoJy9hcGkvdG9kb3MvJyArIHRvZG8uaWQsIHRvZG8pXG5cdFx0XHRcdFx0LnRoZW4oZnVuY3Rpb24gc3VjY2VzcygpIHtcblx0XHRcdFx0XHRcdHJldHVybiBzdG9yZS50b2Rvcztcblx0XHRcdFx0XHR9LCBmdW5jdGlvbiBlcnJvcigpIHtcblx0XHRcdFx0XHRcdGFuZ3VsYXIuY29weShvcmlnaW5hbFRvZG9zLCBzdG9yZS50b2Rvcyk7XG5cdFx0XHRcdFx0XHRyZXR1cm4gb3JpZ2luYWxUb2Rvcztcblx0XHRcdFx0XHR9KTtcblx0XHRcdH1cblx0XHR9O1xuXG5cdFx0cmV0dXJuIHN0b3JlO1xuXHR9KVxuXG5cdC5mYWN0b3J5KCdsb2NhbFN0b3JhZ2UnLCBmdW5jdGlvbiAoJHEpIHtcblx0XHQndXNlIHN0cmljdCc7XG5cblx0XHR2YXIgU1RPUkFHRV9JRCA9ICd0b2Rvcy1hbmd1bGFyanMnO1xuXG5cdFx0dmFyIHN0b3JlID0ge1xuXHRcdFx0dG9kb3M6IFtdLFxuXG5cdFx0XHRfZ2V0RnJvbUxvY2FsU3RvcmFnZTogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRyZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbShTVE9SQUdFX0lEKSB8fCAnW10nKTtcblx0XHRcdH0sXG5cblx0XHRcdF9zYXZlVG9Mb2NhbFN0b3JhZ2U6IGZ1bmN0aW9uICh0b2Rvcykge1xuXHRcdFx0XHRsb2NhbFN0b3JhZ2Uuc2V0SXRlbShTVE9SQUdFX0lELCBKU09OLnN0cmluZ2lmeSh0b2RvcykpO1xuXHRcdFx0fSxcblxuXHRcdFx0Y2xlYXJDb21wbGV0ZWQ6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0dmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuXHRcdFx0XHR2YXIgY29tcGxldGVUb2RvcyA9IFtdO1xuXHRcdFx0XHR2YXIgaW5jb21wbGV0ZVRvZG9zID0gW107XG5cdFx0XHRcdHN0b3JlLnRvZG9zLmZvckVhY2goZnVuY3Rpb24gKHRvZG8pIHtcblx0XHRcdFx0XHRpZiAodG9kby5jb21wbGV0ZWQpIHtcblx0XHRcdFx0XHRcdGNvbXBsZXRlVG9kb3MucHVzaCh0b2RvKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0aW5jb21wbGV0ZVRvZG9zLnB1c2godG9kbyk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRhbmd1bGFyLmNvcHkoaW5jb21wbGV0ZVRvZG9zLCBzdG9yZS50b2Rvcyk7XG5cblx0XHRcdFx0c3RvcmUuX3NhdmVUb0xvY2FsU3RvcmFnZShzdG9yZS50b2Rvcyk7XG5cdFx0XHRcdGRlZmVycmVkLnJlc29sdmUoc3RvcmUudG9kb3MpO1xuXG5cdFx0XHRcdHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuXHRcdFx0fSxcblxuXHRcdFx0ZGVsZXRlOiBmdW5jdGlvbiAodG9kbykge1xuXHRcdFx0XHR2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuXG5cdFx0XHRcdHN0b3JlLnRvZG9zLnNwbGljZShzdG9yZS50b2Rvcy5pbmRleE9mKHRvZG8pLCAxKTtcblxuXHRcdFx0XHRzdG9yZS5fc2F2ZVRvTG9jYWxTdG9yYWdlKHN0b3JlLnRvZG9zKTtcblx0XHRcdFx0ZGVmZXJyZWQucmVzb2x2ZShzdG9yZS50b2Rvcyk7XG5cblx0XHRcdFx0cmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG5cdFx0XHR9LFxuXG5cdFx0XHRnZXQ6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0dmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuXHRcdFx0XHRhbmd1bGFyLmNvcHkoc3RvcmUuX2dldEZyb21Mb2NhbFN0b3JhZ2UoKSwgc3RvcmUudG9kb3MpO1xuXHRcdFx0XHRkZWZlcnJlZC5yZXNvbHZlKHN0b3JlLnRvZG9zKTtcblxuXHRcdFx0XHRyZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblx0XHRcdH0sXG5cblx0XHRcdGluc2VydDogZnVuY3Rpb24gKHRvZG8pIHtcblx0XHRcdFx0dmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcblxuXHRcdFx0XHRzdG9yZS50b2Rvcy5wdXNoKHRvZG8pO1xuXG5cdFx0XHRcdHN0b3JlLl9zYXZlVG9Mb2NhbFN0b3JhZ2Uoc3RvcmUudG9kb3MpO1xuXHRcdFx0XHRkZWZlcnJlZC5yZXNvbHZlKHN0b3JlLnRvZG9zKTtcblxuXHRcdFx0XHRyZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcblx0XHRcdH0sXG5cblx0XHRcdHB1dDogZnVuY3Rpb24gKHRvZG8sIGluZGV4KSB7XG5cdFx0XHRcdHZhciBkZWZlcnJlZCA9ICRxLmRlZmVyKCk7XG5cblx0XHRcdFx0c3RvcmUudG9kb3NbaW5kZXhdID0gdG9kbztcblxuXHRcdFx0XHRzdG9yZS5fc2F2ZVRvTG9jYWxTdG9yYWdlKHN0b3JlLnRvZG9zKTtcblx0XHRcdFx0ZGVmZXJyZWQucmVzb2x2ZShzdG9yZS50b2Rvcyk7XG5cblx0XHRcdFx0cmV0dXJuIGRlZmVycmVkLnByb21pc2U7XG5cdFx0XHR9XG5cdFx0fTtcblxuXHRcdHJldHVybiBzdG9yZTtcblx0fSk7XG5cclxuLypnbG9iYWwgYW5ndWxhciAqL1xuXG4vKipcbiAqIERpcmVjdGl2ZSB0aGF0IGV4ZWN1dGVzIGFuIGV4cHJlc3Npb24gd2hlbiB0aGUgZWxlbWVudCBpdCBpcyBhcHBsaWVkIHRvIGdldHNcbiAqIGFuIGBlc2NhcGVgIGtleWRvd24gZXZlbnQuXG4gKi9cbmFuZ3VsYXIubW9kdWxlKCd0b2RvbXZjJylcblx0LmRpcmVjdGl2ZSgndG9kb0VzY2FwZScsIGZ1bmN0aW9uICgpIHtcblx0XHQndXNlIHN0cmljdCc7XG5cblx0XHR2YXIgRVNDQVBFX0tFWSA9IDI3O1xuXG5cdFx0cmV0dXJuIGZ1bmN0aW9uIChzY29wZSwgZWxlbSwgYXR0cnMpIHtcblx0XHRcdGVsZW0uYmluZCgna2V5ZG93bicsIGZ1bmN0aW9uIChldmVudCkge1xuXHRcdFx0XHRpZiAoZXZlbnQua2V5Q29kZSA9PT0gRVNDQVBFX0tFWSkge1xuXHRcdFx0XHRcdHNjb3BlLiRhcHBseShhdHRycy50b2RvRXNjYXBlKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cblx0XHRcdHNjb3BlLiRvbignJGRlc3Ryb3knLCBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGVsZW0udW5iaW5kKCdrZXlkb3duJyk7XG5cdFx0XHR9KTtcblx0XHR9O1xuXHR9KTtcblxyXG4vKmdsb2JhbCBhbmd1bGFyICovXG5cbi8qKlxuICogRGlyZWN0aXZlIHRoYXQgcGxhY2VzIGZvY3VzIG9uIHRoZSBlbGVtZW50IGl0IGlzIGFwcGxpZWQgdG8gd2hlbiB0aGVcbiAqIGV4cHJlc3Npb24gaXQgYmluZHMgdG8gZXZhbHVhdGVzIHRvIHRydWVcbiAqL1xuYW5ndWxhci5tb2R1bGUoJ3RvZG9tdmMnKVxuXHQuZGlyZWN0aXZlKCd0b2RvRm9jdXMnLCBmdW5jdGlvbiB0b2RvRm9jdXMoJHRpbWVvdXQpIHtcblx0XHQndXNlIHN0cmljdCc7XG5cblx0XHRyZXR1cm4gZnVuY3Rpb24gKHNjb3BlLCBlbGVtLCBhdHRycykge1xuXHRcdFx0c2NvcGUuJHdhdGNoKGF0dHJzLnRvZG9Gb2N1cywgZnVuY3Rpb24gKG5ld1ZhbCkge1xuXHRcdFx0XHRpZiAobmV3VmFsKSB7XG5cdFx0XHRcdFx0JHRpbWVvdXQoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdFx0ZWxlbVswXS5mb2N1cygpO1xuXHRcdFx0XHRcdH0sIDAsIGZhbHNlKTtcblx0XHRcdFx0fVxuXHRcdFx0fSk7XG5cdFx0fTtcblx0fSk7Il19
